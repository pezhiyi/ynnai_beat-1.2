"use strict";(()=>{var e={};e.id=444,e.ids=[444],e.modules={6413:e=>{e.exports=require("cos-nodejs-sdk-v5")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},9092:(e,t,r)=>{r.r(t),r.d(t,{config:()=>f,default:()=>E,routeModule:()=>D});var n={};r.r(n),r.d(n,{default:()=>p});var o=r(1802),i=r(7153),s=r(6249),a=r(6413),u=r.n(a);let c={INFO:"\x1b[36m",WARN:"\x1b[33m",ERROR:"\x1b[31m",DEBUG:"\x1b[35m",RESET:"\x1b[0m"},g={INFO:"\uD83D\uDD35",WARN:"\uD83D\uDFE1",ERROR:"\uD83D\uDD34",DEBUG:"\uD83D\uDFE3"};class m{constructor(e){this.requestId=e||Math.random().toString(36).substring(7),this.startTime=Date.now()}_log(e,t,r={}){let n=new Date().toISOString(),o=Date.now()-this.startTime,i={...r,request_id:this.requestId,time_elapsed:`${o}ms`};return console.log(`${c[e]}[${n}] ${g[e]} ${e} [${this.requestId}][0m`,t),Object.keys(i).length>0&&console.log("\x1b[90m%s\x1b[0m",JSON.stringify(i,null,2)),i}info(e,t={}){return this._log("INFO",e,t)}warn(e,t={}){return this._log("WARN",e,t)}error(e,t={}){return this._log("ERROR",e,t)}debug(e,t={}){return this._log("DEBUG",e,t)}static forRequest(){return new m}}let d=new(u())({SecretId:process.env.TENCENT_CLOUD_SECRET_ID,SecretKey:process.env.TENCENT_CLOUD_SECRET_KEY});async function l(e){let t=m.forRequest();return new Promise((r,n)=>{d.headObject({Bucket:e.Bucket,Region:e.Region,Key:e.Key},(o,i)=>{if(o){t.error("验证上传失败",{error:o,params:e}),n(o);return}t.info("验证上传成功",{key:e.Key,contentLength:i.headers["content-length"],contentType:i.headers["content-type"]}),r(i)})})}async function p(e,t){let r=m.forRequest();try{if("POST"!==e.method)throw Error("Method not allowed");let{image_base64:n}=e.body;if(!n)throw Error("Missing image data");r.info("开始上传图片",{timestamp:new Date().toISOString()});let o=Date.now(),i=`original_${o}.jpg`,s=`matting_${o}.png`,a={Bucket:process.env.TENCENT_CLOUD_BUCKET,Region:process.env.TENCENT_CLOUD_REGION,Key:i,Body:Buffer.from(n,"base64"),Headers:{"Pic-Operations":JSON.stringify({is_pic_info:1,rules:[{fileid:s,rule:"ci-process=AIPicMatting"}]})}};r.info("上传参数",{bucket:a.Bucket,region:a.Region,key:a.Key,bodySize:a.Body.length,timestamp:new Date().toISOString()});let u=await new Promise((e,t)=>{d.putObject(a,(n,o)=>{if(n){r.error("上传失败",{error:n,timestamp:new Date().toISOString()}),t(n);return}r.info("上传成功",{data:o,timestamp:new Date().toISOString()}),e(o)})});try{await l(a)}catch(e){throw r.error("上传验证失败",{error:e,timestamp:new Date().toISOString()}),e}let c=`https://${process.env.TENCENT_CLOUD_BUCKET_DOMAIN}/${s}`,g=await new Promise((e,t)=>{d.getObject({Bucket:process.env.TENCENT_CLOUD_BUCKET,Region:process.env.TENCENT_CLOUD_REGION,Key:s},(n,o)=>{if(n){r.error("获取处理后图片失败",{error:n,timestamp:new Date().toISOString()}),t(n);return}let i=o.Body.toString("base64");e(i)})});return r.info("处理完成",{originalKey:i,processedKey:s,processedImageUrl:c,result:u,timestamp:new Date().toISOString()}),t.status(200).json({success:!0,data:{foreground_image:`data:image/png;base64,${g}`},message:"抠图处理成功"})}catch(e){return r.error("请求失败",{error:{message:e.message,stack:e.stack},timestamp:new Date().toISOString()}),t.status(500).json({success:!1,message:e.message||"处理失败"})}}let E=(0,s.l)(n,"default"),f=(0,s.l)(n,"config"),D=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/image/matting",pathname:"/api/image/matting",bundlePath:"",filename:""},userland:n})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=9092);module.exports=r})();