"use strict";(()=>{var e={};e.id=444,e.ids=[444],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},2911:(e,t,r)=>{r.r(t),r.d(t,{config:()=>I,default:()=>p,routeModule:()=>N});var s={};r.r(s),r.d(s,{default:()=>f});var n=r(1802),a=r(7153),o=r(6249);let u={INFO:"\x1b[36m",WARN:"\x1b[33m",ERROR:"\x1b[31m",DEBUG:"\x1b[35m",RESET:"\x1b[0m"},i={INFO:"\uD83D\uDD35",WARN:"\uD83D\uDFE1",ERROR:"\uD83D\uDD34",DEBUG:"\uD83D\uDFE3"};class l{constructor(e){this.requestId=e||Math.random().toString(36).substring(7),this.startTime=Date.now()}_log(e,t,r={}){let s=new Date().toISOString(),n=Date.now()-this.startTime,a={...r,request_id:this.requestId,time_elapsed:`${n}ms`};return console.log(`${u[e]}[${s}] ${i[e]} ${e} [${this.requestId}][0m`,t),Object.keys(a).length>0&&console.log("\x1b[90m%s\x1b[0m",JSON.stringify(a,null,2)),a}info(e,t={}){return this._log("INFO",e,t)}warn(e,t={}){return this._log("WARN",e,t)}error(e,t={}){return this._log("ERROR",e,t)}debug(e,t={}){return this._log("DEBUG",e,t)}static forRequest(){return new l}}class d extends Error{constructor(e,t,r=500){super(t),this.name="APIError",this.code=e,this.status=r}}let c={INVALID_INPUT:{code:400001,message:"无效的输入参数",status:400},METHOD_NOT_ALLOWED:{code:405001,message:"方法不允许",status:405},INTERNAL_ERROR:{code:500001,message:"服务器内部错误",status:500}},R=(e=null,t="Success",r=null,s=null)=>{let n={code:1e4,message:t,data:e};return r&&(n.request_id=r),s&&(n.time_elapsed=s),n},E=(e=5e4,t="Error",r=null,s=null)=>{let n={code:e,message:t};return r&&(n.request_id=r),s&&(n.time_elapsed=s),n},m=require("cos-nodejs-sdk-v5");var g=r.n(m);let _=require("xml2js");var O=r.n(_);let D=new(g())({SecretId:process.env.TENCENT_CLOUD_SECRET_ID,SecretKey:process.env.TENCENT_CLOUD_SECRET_KEY});async function f(e,t){let r=l.forRequest();try{if(r.info("API Request Started",{method:e.method,url:e.url,headers:{"content-type":e.headers["content-type"],"user-agent":e.headers["user-agent"]}}),"POST"!==e.method)throw new d(c.METHOD_NOT_ALLOWED.code,c.METHOD_NOT_ALLOWED.message,c.METHOD_NOT_ALLOWED.status);let{image_base64:s}=e.body;if(r.info("Image Data Received",{hasImage:!!s,dataLength:s?.length||0,truncatedData:s?.substring(0,50)+"..."}),!s)throw new d(c.INVALID_INPUT.code,"缺少图片数据",c.INVALID_INPUT.status);r.info("Processing Request");let n={Bucket:"ynnai-1256269009",Region:"ap-guangzhou",Key:"ynnai_koutu",Body:Buffer.from(s,"base64"),Headers:{"Pic-Operations":JSON.stringify({is_pic_info:1,rules:[{fileid:"exampleobject",rule:"ci-process=AIPicMatting"}]})}};D.putObject(n,(e,s)=>{if(e)throw r.error("COS Upload Failed",{error:e}),new d(c.INTERNAL_ERROR.code,e.message,c.INTERNAL_ERROR.status);O().parseString(s.Body,(e,n)=>{if(e)throw r.error("XML Parsing Failed",{error:e}),new d(c.INTERNAL_ERROR.code,"XML 解析失败",c.INTERNAL_ERROR.status);let a=n.UploadResult.ProcessResults[0].Object[0].Location[0];return r.info("COS Upload Success",{data:s}),t.status(200).json(R({foreground_image:a},"抠图处理成功",r.requestId,Date.now()-r.startTime))})})}catch(s){r.error("Request Failed",{error:{message:s.message,stack:s.stack?.split("\n"),type:s.name},timeElapsed:`${Date.now()-r.startTime}ms`});let e=E(s.code||c.INTERNAL_ERROR.code,s.message||c.INTERNAL_ERROR.message,r.requestId,Date.now()-r.startTime);return t.status(s.status||500).json(e)}}let p=(0,o.l)(s,"default"),I=(0,o.l)(s,"config"),N=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/image/matting",pathname:"/api/image/matting",bundlePath:"",filename:""},userland:s})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=2911);module.exports=r})();