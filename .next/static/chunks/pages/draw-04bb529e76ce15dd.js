(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[900],{8291:function(e,t,i){(window.__NEXT_P=window.__NEXT_P||[]).push(["/draw",function(){return i(5467)}])},5467:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return y}});var l=i(5893),n=i(7294),s=i(607),a=i(9119),o=i(5364),r=i(6681),c=i(240),h=i(6014);class d extends n.Component{getSnapshotBeforeUpdate(e){let t=this.props.childRef.current;if(t&&e.isPresent&&!this.props.isPresent){let e=this.props.sizeRef.current;e.height=t.offsetHeight||0,e.width=t.offsetWidth||0,e.top=t.offsetTop,e.left=t.offsetLeft}return null}componentDidUpdate(){}render(){return this.props.children}}function u({children:e,isPresent:t}){let i=(0,n.useId)(),s=(0,n.useRef)(null),a=(0,n.useRef)({width:0,height:0,top:0,left:0}),{nonce:o}=(0,n.useContext)(h._);return(0,n.useInsertionEffect)(()=>{let{width:e,height:l,top:n,left:r}=a.current;if(t||!s.current||!e||!l)return;s.current.dataset.motionPopId=i;let c=document.createElement("style");return o&&(c.nonce=o),document.head.appendChild(c),c.sheet&&c.sheet.insertRule(`
          [data-motion-pop-id="${i}"] {
            position: absolute !important;
            width: ${e}px !important;
            height: ${l}px !important;
            top: ${n}px !important;
            left: ${r}px !important;
          }
        `),()=>{document.head.removeChild(c)}},[t]),(0,l.jsx)(d,{isPresent:t,childRef:s,sizeRef:a,children:n.cloneElement(e,{ref:s})})}let x=({children:e,initial:t,isPresent:i,onExitComplete:s,custom:a,presenceAffectsLayout:o,mode:h})=>{let d=(0,r.h)(w),x=(0,n.useId)(),g=(0,n.useCallback)(e=>{for(let t of(d.set(e,!0),d.values()))if(!t)return;s&&s()},[d,s]),m=(0,n.useMemo)(()=>({id:x,initial:t,isPresent:i,custom:a,onExitComplete:g,register:e=>(d.set(e,!1),()=>d.delete(e))}),o?[Math.random(),g]:[i,g]);return(0,n.useMemo)(()=>{d.forEach((e,t)=>d.set(t,!1))},[i]),n.useEffect(()=>{i||d.size||!s||s()},[i]),"popLayout"===h&&(e=(0,l.jsx)(u,{isPresent:i,children:e})),(0,l.jsx)(c.O.Provider,{value:m,children:e})};function w(){return new Map}var g=i(5947);let m=e=>e.key||"";function v(e){let t=[];return n.Children.forEach(e,e=>{(0,n.isValidElement)(e)&&t.push(e)}),t}var p=i(8868);let f=({children:e,custom:t,initial:i=!0,onExitComplete:s,presenceAffectsLayout:a=!0,mode:c="sync",propagate:h=!1})=>{let[d,u]=(0,g.oO)(h),w=(0,n.useMemo)(()=>v(e),[e]),f=h&&!d?[]:w.map(m),j=(0,n.useRef)(!0),y=(0,n.useRef)(w),b=(0,r.h)(()=>new Map),[N,k]=(0,n.useState)(w),[C,E]=(0,n.useState)(w);(0,p.L)(()=>{j.current=!1,y.current=w;for(let e=0;e<C.length;e++){let t=m(C[e]);f.includes(t)?b.delete(t):!0!==b.get(t)&&b.set(t,!1)}},[C,f.length,f.join("-")]);let M=[];if(w!==N){let e=[...w];for(let t=0;t<C.length;t++){let i=C[t],l=m(i);f.includes(l)||(e.splice(t,0,i),M.push(i))}"wait"===c&&M.length&&(e=M),E(v(e)),k(w);return}let{forceRender:R}=(0,n.useContext)(o.p);return(0,l.jsx)(l.Fragment,{children:C.map(e=>{let n=m(e),o=(!h||!!d)&&(w===C||f.includes(n));return(0,l.jsx)(x,{isPresent:o,initial:(!j.current||!!i)&&void 0,custom:o?void 0:t,presenceAffectsLayout:a,mode:c,onExitComplete:o?void 0:()=>{if(!b.has(n))return;b.set(n,!0);let e=!0;b.forEach(t=>{t||(e=!1)}),e&&(null==R||R(),E(y.current),h&&(null==u||u()),s&&s())},children:e},n)})})};var j=e=>{let{isOpen:t,onClose:i,layers:a,selectedLayer:o,dimensions:r,canvasRef:c,onImageUpdate:h,editMode:d,children:u}=e,x=(0,n.useRef)(null),[w,g]=(0,n.useState)([]),[m,v]=(0,n.useState)(-1),[p,j]=(0,n.useState)({top:0,left:0}),[y,b]=(0,n.useState)(!1),[N,k]=(0,n.useState)(!1),[C,E]=(0,n.useState)(100),[M,R]=(0,n.useState)(0),[S,B]=(0,n.useState)({}),[P,H]=(0,n.useState)(null);(0,n.useEffect)(()=>{if(!(null==c?void 0:c.current))return;let e=c.current.getBoundingClientRect(),t=window.pageXOffset||document.documentElement.scrollLeft,i=window.pageYOffset||document.documentElement.scrollTop;j({top:e.top+i,left:e.left+t})},[c,t]),(0,n.useEffect)(()=>{if(!t||!(null==a?void 0:a.length)||!x.current)return;let e=x.current,i=e.getContext("2d"),l=window.devicePixelRatio||1;e.width=r.width*l,e.height=r.height*l,e.style.width="".concat(r.width,"px"),e.style.height="".concat(r.height,"px"),i.scale(l,l),i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high";let n=new Image;n.onload=()=>{let t,s,a,o;let r=n.width/n.height;r>e.width/l/(e.height/l)?(s=(t=e.width/l)/r,a=0,o=(e.height/l-s)/2):(t=(s=e.height/l)*r,a=(e.width/l-t)/2,o=0),i.clearRect(0,0,e.width,e.height),i.drawImage(n,a,o,t,s);let c=document.createElement("canvas");c.width=e.width,c.height=e.height,c.getContext("2d").drawImage(e,0,0),H(c),g([e.toDataURL()]),v(0)};let s=1===a.length?a[0]:a.find(e=>e.id===o);s&&(n.src=s.src)},[t,a,r,o]);let W=()=>{if(!x.current)return;let e=x.current.toDataURL();g(t=>[...t.slice(0,m+1),e]),v(e=>e+1),k(!0)},I=e=>{if(!x.current)return;let t=x.current.getContext("2d"),i=new Image;i.onload=()=>{t.clearRect(0,0,x.current.width,x.current.height),t.drawImage(i,0,0,x.current.width,x.current.height)},i.src=e},L=()=>{if(!x.current)return;let e=x.current;e.getContext("2d");let t=window.devicePixelRatio||1,l=document.createElement("canvas");l.width=r.width*t,l.height=r.height*t;let n=l.getContext("2d"),s=Math.min(r.width*t/e.width,r.height*t/e.height),a=(l.width-e.width*s)/2,o=(l.height-e.height*s)/2;n.drawImage(e,a,o,e.width*s,e.height*s),h(l.toDataURL()),i()},T=e=>{if(!x.current||y)return;b(!0);let t=x.current,i=t.getContext("2d"),l=window.devicePixelRatio||1,n=P.width*e,s=P.height*e;t.width=P.width,t.height=P.height,t.style.width="".concat(P.width/l,"px"),t.style.height="".concat(P.height/l,"px"),i.clearRect(0,0,t.width,t.height),i.save(),i.translate((t.width-n)/2,(t.height-s)/2),i.scale(e,e),i.drawImage(P,0,0),i.restore(),b(!1),W()},z=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1.2;if(!x.current||y)return;b(!0);let t=x.current,i=t.getContext("2d"),l=i.getImageData(0,0,t.width,t.height),n=l.data;for(let t=0;t<n.length;t+=4)n[t]=Math.min(255,n[t]*e),n[t+1]=Math.min(255,n[t+1]*e),n[t+2]=Math.min(255,n[t+2]*e);i.putImageData(l,0,0),b(!1),W()},D=e=>{if(!x.current||!P||y)return;b(!0);let t=x.current,i=t.getContext("2d"),l=window.devicePixelRatio||1,n=P.width,s=P.height;t.width=n,t.height=s,t.style.width="".concat(n/l,"px"),t.style.height="".concat(s/l,"px"),i.clearRect(0,0,t.width,t.height),i.save(),i.translate(n/2,s/2),i.rotate(e*Math.PI/180),i.translate(-P.width/2,-P.height/2),i.drawImage(P,0,0),i.restore(),b(!1),W()},_=e=>{let t=parseInt(e.target.value);switch(d){case"rotate":R(t),D(t);break;case"zoom":let i=t/C;E(t),T(i)}},O=e=>{"enhance"===e&&z()};(0,n.useEffect)(()=>{t||(k(!1),g([]),v(-1),E(100),R(0),H(null))},[t]);let U=async()=>{if(!x.current||y)return;b(!0);let e=x.current;try{var t;let i=e.toDataURL("image/jpeg",.8).split(",")[1];console.log("Sending matting request...");let l=await fetch("/api/matting",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_base64:i})});if(console.log("Received response:",l.status),!l.ok){let e=await l.json();throw Error(e.message||"抠图请求失败: ".concat(l.status))}let n=await l.json();if(console.log("Response data:",n),1e4!==n.code)throw Error(n.message||"抠图处理失败");if(!(null===(t=n.data)||void 0===t?void 0:t.foreground_image))throw Error("返回数据中缺少抠图结果");let s=new Image;s.onload=()=>{let t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),t.drawImage(s,0,0,e.width,e.height),b(!1),W()},s.src="data:image/png;base64,".concat(n.data.foreground_image)}catch(e){console.error("抠图处理错误:",e),alert(e.message||"抠图处理失败，请重试"),b(!1)}};return t?(0,l.jsxs)(f,{children:[(0,l.jsx)(s.E.div,{className:"modal-backdrop",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0}}),(0,l.jsx)(s.E.div,{className:"modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},style:{width:r.width,height:1.19*r.height,position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:(0,l.jsxs)(s.E.div,{className:"modal-content",initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},children:[(0,l.jsx)("div",{className:"modal-header",children:(0,l.jsx)("button",{className:"close-button",onClick:()=>{N?window.confirm("是否应用当前的编辑更改？")?L():(k(!1),i()):i()},children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,l.jsx)("path",{d:"M18 6L6 18M6 6l12 12"})})})}),(0,l.jsxs)("div",{className:"modal-body",children:[(0,l.jsx)("div",{className:"edit-canvas-container",style:{height:"84%"},children:(0,l.jsx)("canvas",{ref:x,className:"edit-canvas",style:{position:"relative",width:"100%",height:"100%",...S}})}),("zoom"===d||"rotate"===d)&&(0,l.jsxs)("div",{className:"slider-controls",children:["rotate"===d&&(0,l.jsxs)("div",{className:"slider-group",children:[(0,l.jsx)("input",{type:"range",min:"-180",max:"180",value:M,onChange:_,className:"edit-slider"}),(0,l.jsxs)("span",{className:"slider-value",children:[M,"\xb0"]})]}),"zoom"===d&&(0,l.jsxs)("div",{className:"slider-group",children:[(0,l.jsx)("input",{type:"range",min:"50",max:"200",value:C,onChange:_,className:"edit-slider"}),(0,l.jsxs)("span",{className:"slider-value",children:[C,"%"]})]})]}),(0,l.jsxs)("div",{className:"edit-tools",children:[(0,l.jsx)("div",{className:"tool-icons",children:u&&n.Children.map(u,e=>{if(!e)return null;let t=n.Children.toArray(e.props.children).find(e=>"svg"===e.type||e.props&&"button-icon"===e.props.className);return n.cloneElement(e,{onClick:()=>O(d),disabled:y,className:"tool-button icon-only",children:t})})}),(0,l.jsxs)("div",{className:"action-buttons",children:[(0,l.jsx)("button",{className:"tool-button icon-only apply",onClick:L,disabled:y||w.length<=1,children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,l.jsx)("path",{d:"M20 6L9 17l-5-5"})})}),(0,l.jsx)("button",{className:"tool-button icon-only",onClick:()=>{m>0&&(v(e=>e-1),I(w[m-1]))},disabled:y||m<=0,children:(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M9 14L4 9l5-5"}),(0,l.jsx)("path",{d:"M4 9h11a4 4 0 0 1 0 8h-1"})]})}),(0,l.jsx)("button",{className:"tool-button icon-only",onClick:()=>{m<w.length-1&&(v(e=>e+1),I(w[m+1]))},disabled:y||m>=w.length-1,children:(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M15 14l5-5-5-5"}),(0,l.jsx)("path",{d:"M20 9H9a4 4 0 0 0 0 8h1"})]})}),"matting"===d&&(0,l.jsxs)(s.E.button,{className:"tool-button",onClick:U,whileHover:{scale:1.05},whileTap:{scale:.95},disabled:y,children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"}),(0,l.jsx)("path",{d:"M12 6v12"}),(0,l.jsx)("path",{d:"M6 12h12"})]}),(0,l.jsx)("span",{className:"button-text",children:y?"处理中...":"抠图"})]})]})]})]})]})})]}):null};function y(){let e=(0,n.useRef)(null),t=(0,n.useRef)(null),[i,o]=(0,n.useState)({width:0,height:0}),[r,c]=(0,n.useState)(!1),[h,d]=(0,n.useState)(!1),[u,x]=(0,n.useState)([]),[w,g]=(0,n.useState)(!1),m=(0,n.useRef)(null),[v,p]=(0,n.useState)(null),[f,y]=(0,n.useState)({}),[b,N]=(0,n.useState)(!1),[k,C]=(0,n.useState)({x:0,y:0}),[E,M]=(0,n.useState)({}),R=(0,n.useRef)(null),[S,B]=(0,n.useState)(null),[P,H]=(0,n.useState)(0),[W,I]=(0,n.useState)(!1),L=()=>{let e=Math.min(window.innerWidth-32,800),t=e/(3/4),i=window.innerHeight-32-80-50;t>i?o({width:3/4*i,height:i}):o({width:e,height:t})};(0,n.useEffect)(()=>(L(),window.addEventListener("resize",L),()=>window.removeEventListener("resize",L)),[]),(0,n.useEffect)(()=>{if(e.current&&i.width&&i.height){let t=e.current,l=t.getContext("2d"),n=window.devicePixelRatio||1;t.width=i.width*n,t.height=i.height*n,t.style.width="".concat(i.width,"px"),t.style.height="".concat(i.height,"px"),l.scale(n,n),l.imageSmoothingEnabled=!0,l.imageSmoothingQuality="high",l.fillStyle="#ffffff",l.fillRect(0,0,i.width,i.height)}},[i]);let T=t=>{if(!t.type.startsWith("image/")){alert("请选择图片文件");return}let l=new FileReader;l.onload=l=>{var n;let s=new Image;s.onload=()=>{var n;let a,o,r,h;let d=e.current;if(!d)return;let u=d.getContext("2d"),w=window.devicePixelRatio||1,g=i.width*w,m=g/(3/4);d.width=g,d.height=m,d.style.width="".concat(g/w,"px"),d.style.height="".concat(m/w,"px"),u.fillStyle="#ffffff",u.fillRect(0,0,g,m),u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high";let v=s.width/s.height;if(1===v){let e=Math.min(g,m);a=e,o=e,r=(g-e)/2,h=(m-e)/2}else v>1?(a=g,r=0,h=(m-(o=g/v))/2):(o=m,r=(g-(a=m*v))/2,h=0);u.drawImage(s,r,h,a,o),c(!0);let p={id:Date.now(),name:t.name,src:(null===(n=l.target)||void 0===n?void 0:n.result)||"",visible:!0,width:s.width,height:s.height};x([p]),y({[p.id]:{x:0,y:0}})},s.src=(null===(n=l.target)||void 0===n?void 0:n.result)||""},l.readAsDataURL(t)},z=e=>{if(!e.type.startsWith("image/")){alert("请选择图片文件");return}if(u.length>=5){alert("最多只能添加5个图层");return}let t=new FileReader;t.onload=t=>{var i;let l=new Image;l.onload=()=>{var i;let n={id:Date.now(),name:e.name,src:(null===(i=t.target)||void 0===i?void 0:i.result)||"",visible:!0,width:l.width,height:l.height};x(e=>[n,...e]),y(e=>({...e,[n.id]:{x:0,y:0}}))},l.src=(null===(i=t.target)||void 0===i?void 0:i.result)||""},t.readAsDataURL(e)},D=e=>{if(0===e)return;let t=[...u];[t[e],t[e-1]]=[t[e-1],t[e]],x(t)},_=e=>{if(e===u.length-1)return;let t=[...u];[t[e],t[e+1]]=[t[e+1],t[e]],x(t)},O=e=>{x(t=>t.map(t=>t.id===e?{...t,visible:!t.visible}:t))},U=(e,t)=>{null==t||t.stopPropagation(),p(e===v?null:e)},F=(0,n.useCallback)((e,t,i)=>{let{left:l,top:n,width:s,height:a}=i;return e>=l&&e<=l+s&&t>=n&&t<=n+a},[]),A=(0,n.useCallback)((t,i)=>{let l=e.current;if(!l)return null;let n=window.devicePixelRatio||1;for(let e of u){let s,a,o,r;if(!e.visible)continue;let c=new Image;c.src=e.src;let h=c.width/c.height;if(1===h){let e=Math.min(l.width,l.height);s=e/n,a=e/n,o=(l.width/n-s)/2,r=(l.height/n-a)/2}else h>1?(s=l.width/n,a=l.width/n/h,o=0,r=(l.height/n-a)/2):(a=l.height/n,s=l.height/n*h,o=(l.width/n-s)/2,r=0);let d=f[e.id]||{x:0,y:0};if(F(t,i,{left:o+=d.x,top:r+=d.y,width:s,height:a}))return e.id}return null},[u,f,F]);(0,n.useCallback)(e=>new Promise(t=>{if(E[e.id]){t(E[e.id]);return}let i=new Image;i.onload=()=>{M(t=>({...t,[e.id]:i})),t(i)},i.src=e.src}),[E]),(0,n.useEffect)(()=>{if(i.width&&i.height){let e=document.createElement("canvas"),t=window.devicePixelRatio||1;e.width=i.width*t,e.height=i.height*t,R.current=e}},[i]);let X=(0,n.useCallback)(()=>{if(!e.current)return;let t=e.current,i=t.getContext("2d"),l=window.devicePixelRatio||1;i.fillStyle="#ffffff",i.fillRect(0,0,t.width,t.height),Promise.all([...u].reverse().map(e=>e.visible?new Promise((n,s)=>{let a=new Image;a.onload=()=>{try{let s,o,r,c;let h=a.width/a.height;if(1===h){let e=Math.min(t.width,t.height);s=e,o=e,r=(t.width-e)/2,c=(t.height-e)/2}else h>1?(s=t.width,o=t.width/h,r=0,c=(t.height-o)/2):(o=t.height,s=t.height*h,r=(t.width-s)/2,c=0);let d=f[e.id]||{x:0,y:0};i.save(),i.translate(d.x*l,d.y*l),e.id===v&&(i.shadowColor="rgba(59, 130, 246, 0.5)",i.shadowBlur=8,i.shadowOffsetX=0,i.shadowOffsetY=0),i.drawImage(a,r,c,s,o),i.restore(),n()}catch(e){console.error("Error drawing layer:",e),s(e)}},a.onerror=()=>{console.error("Error loading image for layer:",e.id),s(Error("Image load failed"))},a.src=e.src}):Promise.resolve())).catch(e=>{console.error("Error rendering layers:",e)})},[u,f,v]),V=(0,n.useCallback)((e,t,i)=>{let l=requestAnimationFrame(()=>{y(l=>{var n,s;return{...l,[e]:{x:((null===(n=l[e])||void 0===n?void 0:n.x)||0)+t,y:((null===(s=l[e])||void 0===s?void 0:s.y)||0)+i}}})});return()=>cancelAnimationFrame(l)},[]),Y=(0,n.useCallback)(t=>{var i;if(!b||!v&&!r)return;let l=e.current.getBoundingClientRect(),n=t.clientX-l.left,s=t.clientY-l.top,a=(n-k.x)/(window.devicePixelRatio||1),o=(s-k.y)/(window.devicePixelRatio||1),c=v||(null===(i=u[0])||void 0===i?void 0:i.id);c&&V(c,a,o),C({x:n,y:s})},[b,v,r,u,k,V]),$=()=>{N(!1)};(0,n.useEffect)(()=>{X()},[u,X]);let q=()=>{N(!1)};(0,n.useCallback)(e=>{let t=document.createElement("canvas"),i=t.getContext("2d");t.width=40,t.height=40;let l=new Image;return l.onload=()=>{let e,t,n,s;let a=l.width/l.height;1===a?(e=t=40,n=s=0):a>1?(e=40,n=0,s=(40-(t=40/a))/2):(t=40,n=(40-(e=40*a))/2,s=0),i.drawImage(l,n,s,e,t)},l.src=e.src,t},[]);let G=(0,n.useCallback)(e=>{!w||e.target.closest(".layers-panel")||e.target.closest(".canvas-layers")||g(!1)},[w]);(0,n.useEffect)(()=>(document.addEventListener("mousedown",G),()=>{document.removeEventListener("mousedown",G)}),[G]);let Q=e=>{x(t=>t.filter(t=>t.id!==e)),v===e&&p(null)},J=e=>{e.target.closest(".draw-canvas")||e.target.closest(".layers-panel")||e.target.closest(".layers-mini")||p(null)};return(0,n.useEffect)(()=>(document.addEventListener("click",J),()=>{document.removeEventListener("click",J)}),[]),(0,l.jsxs)(a.Z,{children:[(0,l.jsxs)("div",{className:"draw-container",children:[(0,l.jsxs)(s.E.div,{className:"canvas-wrapper ".concat(h?"dragging":""),initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},onDragOver:e=>{e.preventDefault(),e.stopPropagation(),d(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),d(!1)},onDrop:e=>{var t;e.preventDefault(),e.stopPropagation(),d(!1);let i=null===(t=e.dataTransfer.files)||void 0===t?void 0:t[0];i&&T(i)},children:[(0,l.jsx)("canvas",{ref:e,className:"draw-canvas ".concat(h?"dragging":""),width:i.width,height:i.height,onMouseDown:t=>{let i=e.current;if(!i)return;let l=i.getBoundingClientRect(),n=t.clientX-l.left,s=t.clientY-l.top,a=A(n,s);a?(N(!0),C({x:n,y:s}),p(a)):p(null)},onMouseMove:Y,onMouseUp:$,onMouseLeave:$,onTouchStart:t=>{if(!r)return;let i=e.current.getBoundingClientRect(),l=t.touches[0],n=l.clientX-i.left,s=l.clientY-i.top,a=A(n,s);a?(p(a),N(!0),C({x:n,y:s})):p(null)},onTouchMove:t=>{var i;if(!b||!v&&!r)return;t.preventDefault();let l=e.current.getBoundingClientRect(),n=t.touches[0],s=n.clientX-l.left,a=n.clientY-l.top,o=s-k.x,c=a-k.y,h=v||(null===(i=u[0])||void 0===i?void 0:i.id);h&&V(h,o,c),C({x:s,y:a})},onTouchEnd:q,onTouchCancel:q,style:{cursor:r?"move":"default",position:"relative"},children:u.map((e,t)=>{var i,n;return(0,l.jsx)("div",{className:"canvas-layer ".concat(v===e.id?"selected":""),style:{position:"absolute",left:(null===(i=f[e.id])||void 0===i?void 0:i.x)||0,top:(null===(n=f[e.id])||void 0===n?void 0:n.y)||0,display:e.visible?"block":"none",zIndex:u.length-t,pointerEvents:"none"},children:(0,l.jsx)("img",{src:e.src,alt:"图层 ".concat(t+1),style:{width:e.width,height:e.height,pointerEvents:"none"},draggable:!1})},e.id)})}),(0,l.jsx)("input",{type:"file",ref:m,onChange:e=>{var t;let i=null===(t=e.target.files)||void 0===t?void 0:t[0];i&&z(i)},accept:"image/*",style:{display:"none"}}),(0,l.jsxs)("div",{className:"layers-container",children:[(0,l.jsxs)(s.E.button,{className:"canvas-layers",onClick:()=>g(!w),initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:.3},title:"图层管理",children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),(0,l.jsx)("path",{d:"M2 17l10 5 10-5"}),(0,l.jsx)("path",{d:"M2 12l10 5 10-5"})]}),(0,l.jsx)("span",{className:"layer-count",children:u.length})]}),!w&&u.length>0&&(0,l.jsx)(s.E.div,{className:"layers-mini",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.3},children:u.map((e,t)=>(0,l.jsxs)(s.E.div,{className:"layer-mini-item ".concat(e.visible?"visible":""," ").concat(v===e.id?"selected":""),initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{duration:.2,delay:.05*t},onClick:t=>U(e.id,t),children:[(0,l.jsx)("img",{src:e.src,alt:e.name,className:"layer-mini-preview",draggable:!1}),(0,l.jsx)("span",{className:"layer-mini-index",children:t+1})]},e.id))}),w&&(0,l.jsxs)(s.E.div,{className:"layers-panel",initial:{opacity:0,scale:.95,x:-20},animate:{opacity:1,scale:1,x:0},transition:{duration:.3},children:[(0,l.jsx)("div",{className:"layers-list",children:u.map((e,t)=>(0,l.jsxs)(s.E.div,{className:"layer-item ".concat(e.visible?"visible":""," ").concat(v===e.id?"selected":""),initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{duration:.2,delay:.05*t},children:[(0,l.jsxs)("div",{className:"layer-preview-container ".concat(v===e.id?"selected":""),onClick:t=>U(e.id,t),children:[(0,l.jsx)("img",{src:e.src,alt:"图层 ".concat(t+1),className:"layer-preview",draggable:!1}),(0,l.jsx)("span",{className:"layer-index",children:t+1})]}),(0,l.jsxs)("div",{className:"layer-controls",children:[(0,l.jsx)("button",{className:"layer-visibility ".concat(e.visible?"visible":""),onClick:t=>{t.stopPropagation(),O(e.id)},title:e.visible?"隐藏图层":"显示图层",children:(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"}),(0,l.jsx)("circle",{cx:"12",cy:"12",r:"3"})]})}),(0,l.jsx)("button",{className:"layer-move-btn",onClick:e=>{e.stopPropagation(),D(t)},disabled:0===t,title:"上移图层",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,l.jsx)("path",{d:"M12 19V5M5 12l7-7 7 7"})})}),(0,l.jsx)("button",{className:"layer-move-btn",onClick:e=>{e.stopPropagation(),_(t)},disabled:t===u.length-1,title:"下移图层",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,l.jsx)("path",{d:"M12 5v14M5 12l7 7 7-7"})})}),(0,l.jsx)("button",{className:"layer-delete-btn",onClick:t=>{t.stopPropagation(),Q(e.id)},title:"删除图层",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,l.jsx)("path",{d:"M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"})})})]})]},e.id))}),u.length<5&&(0,l.jsx)("div",{className:"layers-footer",children:(0,l.jsx)(s.E.button,{className:"layer-add-btn",onClick:()=>{var e;null===(e=m.current)||void 0===e||e.click()},whileHover:{scale:1.02},whileTap:{scale:.98},title:"添加图层",children:(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),(0,l.jsx)("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})})]})]}),r&&(0,l.jsx)(s.E.button,{className:"canvas-download",onClick:()=>{p(null),requestAnimationFrame(()=>{let t=e.current;if(!t)return;let i=document.createElement("a");i.download="canvas-image.png",i.href=t.toDataURL("image/png"),i.click()})},initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:.3},title:"下载图片",children:(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),(0,l.jsx)("polyline",{points:"7 10 12 15 17 10"}),(0,l.jsx)("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}),!r&&(0,l.jsxs)("div",{className:"upload-hint",children:[(0,l.jsx)("div",{className:"hint-icon",children:(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),(0,l.jsx)("polyline",{points:"17 8 12 3 7 8"}),(0,l.jsx)("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]})}),(0,l.jsx)("h3",{children:"点击或拖拽上传图片"}),(0,l.jsx)("p",{children:"支持 JPG、PNG、GIF 格式"})]})]}),r&&(0,l.jsx)(s.E.div,{className:"canvas-tools",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.1},children:(0,l.jsx)("div",{className:"tools-buttons ".concat(S?"editing":""),children:S?(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(s.E.div,{className:"edit-controls",initial:{x:20,opacity:0},animate:{x:0,opacity:1},transition:{duration:.3,delay:.1}})}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(s.E.button,{className:"tool-button matting",onClick:()=>{if(u.length>1&&!v){alert("请先选择要编辑的图层");return}B("matting"),I(!0)},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("circle",{cx:"6",cy:"6",r:"3"}),(0,l.jsx)("circle",{cx:"6",cy:"18",r:"3"}),(0,l.jsx)("line",{x1:"20",y1:"4",x2:"8.12",y2:"15.88"}),(0,l.jsx)("line",{x1:"14.47",y1:"14.48",x2:"20",y2:"20"}),(0,l.jsx)("line",{x1:"8.12",y1:"8.12",x2:"12",y2:"12"})]}),(0,l.jsx)("span",{className:"button-text",children:"抠图"})]}),(0,l.jsxs)(s.E.button,{className:"tool-button enhance",onClick:()=>{if(u.length>1&&!v){alert("请先选择要编辑的图层");return}B("enhance"),I(!0)},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("circle",{cx:"12",cy:"12",r:"3"}),(0,l.jsx)("path",{d:"M12 4v2M12 18v2M4 12H2M22 12h-2M19.07 4.93l-1.41 1.41M6.34 17.66l-1.41 1.41M19.07 19.07l-1.41-1.41M6.34 6.34L4.93 4.93"})]}),(0,l.jsx)("span",{className:"button-text",children:"增强"})]}),(0,l.jsxs)(s.E.button,{className:"tool-button erase",onClick:()=>{if(u.length>1&&!v){alert("请先选择要编辑的图层");return}B("erase"),I(!0)},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,l.jsx)("path",{d:"M20 20H7L3 16c-.7-.7-.7-1.3 0-2l7-7c.7-.7 1.3-.7 2 0l5 5c.7.7.7 1.3 0 2l-7 7"})}),(0,l.jsx)("span",{className:"button-text",children:"擦除"})]}),(0,l.jsxs)(s.E.button,{className:"tool-button rotate",onClick:()=>{if(u.length>1&&!v){alert("请先选择要编辑的图层");return}B("rotate"),I(!0)},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),(0,l.jsx)("path",{d:"M3 3v5h5"})]}),(0,l.jsx)("span",{className:"button-text",children:"旋转"})]}),(0,l.jsxs)(s.E.button,{className:"tool-button zoom",onClick:()=>{if(u.length>1&&!v){alert("请先选择要编辑的图层");return}B("zoom"),I(!0)},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,l.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"}),(0,l.jsx)("line",{x1:"11",y1:"8",x2:"11",y2:"14"}),(0,l.jsx)("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]}),(0,l.jsx)("span",{className:"button-text",children:"缩放"})]})]})})}),(0,l.jsx)(s.E.div,{className:"canvas-buttons",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},children:r?(0,l.jsxs)("div",{className:"function-buttons",children:[(0,l.jsxs)(s.E.button,{className:"canvas-button smart-portrait",onClick:()=>{console.log("智能画像")},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"}),(0,l.jsx)("path",{d:"M12 6a4 4 0 1 0 4 4 4 4 0 0 0-4-4z"})]}),"智能画像"]}),(0,l.jsxs)(s.E.button,{className:"canvas-button style",onClick:()=>{console.log("风格叠加")},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M2 2h20v20H2z"}),(0,l.jsx)("path",{d:"M7 7h10v10H7z"})]}),"风格叠加"]}),(0,l.jsxs)(s.E.button,{className:"canvas-button product",onClick:()=>{console.log("商品选择")},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M21 8l-3-6H6L3 8v12h18V8z"}),(0,l.jsx)("path",{d:"M3 8h18"}),(0,l.jsx)("path",{d:"M15 8a3 3 0 0 1-6 0"})]}),"商品选择"]}),(0,l.jsxs)(s.E.button,{className:"canvas-button order",onClick:()=>{console.log("订单发货")},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M5 12h14"}),(0,l.jsx)("path",{d:"M12 5l7 7-7 7"})]}),"订单发货"]})]}):(0,l.jsxs)("div",{className:"initial-buttons",children:[(0,l.jsx)("input",{type:"file",ref:t,onChange:e=>{var t;let i=null===(t=e.target.files)||void 0===t?void 0:t[0];i&&T(i)},accept:"image/*",style:{display:"none"}}),(0,l.jsxs)(s.E.button,{className:"canvas-button upload",onClick:()=>{var e;null===(e=t.current)||void 0===e||e.click()},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),(0,l.jsx)("polyline",{points:"17 8 12 3 7 8"}),(0,l.jsx)("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]}),"上传图片"]}),(0,l.jsxs)(s.E.button,{className:"canvas-button archive",onClick:()=>{console.log("存档仓库")},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M21 8v13H3V8"}),(0,l.jsx)("path",{d:"M1 3h22v5H1z"}),(0,l.jsx)("path",{d:"M10 12h4"})]}),"存档仓库"]})]})})]}),(0,l.jsxs)(j,{isOpen:W,onClose:()=>{I(!1),B(null)},layers:u,selectedLayer:v,dimensions:i,canvasRef:e,onImageUpdate:e=>{x(t=>{let i=[...t],l=1===u.length?0:i.findIndex(e=>e.id===v);return -1!==l&&(i[l]={...i[l],src:e}),i})},editMode:S,children:["matting"===S&&(0,l.jsxs)(s.E.button,{className:"tool-button",onClick:()=>{},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"}),(0,l.jsx)("path",{d:"M12 6v12"}),(0,l.jsx)("path",{d:"M6 12h12"})]}),(0,l.jsx)("span",{className:"button-text",children:"抠图"})]}),"enhance"===S&&(0,l.jsxs)(s.E.button,{className:"tool-button",onClick:()=>{},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("circle",{cx:"12",cy:"12",r:"3"}),(0,l.jsx)("path",{d:"M12 4v2M12 18v2M4 12H2M22 12h-2M19.07 4.93l-1.41 1.41M6.34 17.66l-1.41 1.41M19.07 19.07l-1.41-1.41M6.34 6.34L4.93 4.93"})]}),(0,l.jsx)("span",{className:"button-text",children:"增强"})]}),"erase"===S&&(0,l.jsxs)(s.E.button,{className:"tool-button",onClick:()=>{},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,l.jsx)("path",{d:"M20 20H7L3 16c-.7-.7-.7-1.3 0-2l7-7c.7-.7 1.3-.7 2 0l5 5c.7.7.7 1.3 0 2l-7 7"})}),(0,l.jsx)("span",{className:"button-text",children:"擦除"})]}),"rotate"===S&&(0,l.jsxs)(s.E.button,{className:"tool-button",onClick:()=>{},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),(0,l.jsx)("path",{d:"M3 3v5h5"})]}),(0,l.jsx)("span",{className:"button-text",children:"旋转"})]}),"zoom"===S&&(0,l.jsxs)(s.E.button,{className:"tool-button",onClick:()=>{},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"button-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,l.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,l.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"}),(0,l.jsx)("line",{x1:"11",y1:"8",x2:"11",y2:"14"}),(0,l.jsx)("line",{x1:"8",y1:"11",x2:"14",y2:"11"})]}),(0,l.jsx)("span",{className:"button-text",children:"缩放"})]})]})]})}}},function(e){e.O(0,[774,888,179],function(){return e(e.s=8291)}),_N_E=e.O()}]);